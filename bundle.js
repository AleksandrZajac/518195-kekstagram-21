(()=>{"use strict";(()=>{const e={POST:"https://21.javascript.pages.academy/kekstagram",GET:"https://21.javascript.pages.academy/kekstagram/data"},t="POST";window.http=(o,s,n)=>{const l=n?t:"GET",r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{200===r.status?o(r.response):s("Статус ответа: "+r.status+" "+r.statusText)})),r.addEventListener("error",(()=>{s("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{s("Запрос не успел выполниться за "+r.timeout+" мс")})),r.timeout=3e3,r.open(l,e[l]),l===t?r.send(n):r.send()}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=document.querySelector(".pictures"),t=e.querySelector(".pictures__title"),o=document.createDocumentFragment(),s=document.querySelector("#picture").content.querySelector(".picture");t.classList.remove("visually-hidden");const n=e=>{const t=s.cloneNode(!0),o=t.querySelector(".picture__img"),n=t.querySelector(".picture__comments"),l=t.querySelector(".picture__likes");return o.src=e.url,o.alt="Photo",n.textContent=e.comments.length,l.textContent=e.like,t};window.gallery={createGallery:(t,s)=>{(()=>{const t=e.querySelectorAll(".picture");for(let o=0;o<t.length;o++)e.removeChild(t[o])})();let l=t.length;s&&(l=s);for(let e=0;e<l;e++){const s=n(t[e]);s.addEventListener("click",(()=>{window.picture.show(t[e])})),o.append(s)}e.append(o)}}})(),(()=>{const e=document.querySelector(".img-filters"),t=document.querySelector("#filter-default"),o=document.querySelector("#filter-random"),s=document.querySelector("#filter-discussed"),n=document.querySelectorAll(".img-filters__button"),l=window.debounce((t=>{window.gallery.createGallery(t),t&&e.classList.remove("img-filters--inactive")})),r=window.debounce((e=>{const t=e.slice().sort((()=>Math.round(100*Math.random())-50));window.gallery.createGallery(t,10)})),c=window.debounce((e=>{const t=e.slice();t.sort(((e,t)=>t.comments.length-e.comments.length)),window.gallery.createGallery(t)})),i=()=>{for(let e=0;e<n.length;e++)n[e].classList.contains("img-filters__button--active")&&n[e].classList.remove("img-filters__button--active")};window.http((e=>{l(e),t.addEventListener("click",(()=>{l(e),i(),t.classList.add("img-filters__button--active")})),o.addEventListener("click",(()=>{r(e),i(),o.classList.add("img-filters__button--active")})),s.addEventListener("click",(()=>{c(e),i(),s.classList.add("img-filters__button--active")}))}),(e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; padding: 20px; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}))})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".big-picture__img").querySelector("img"),o=e.querySelector(".likes-count"),s=document.querySelector(".social__comments"),n=document.createDocumentFragment(),l=document.querySelector(".comments-loader"),r=document.querySelector("#social__comment").content.querySelector(".social__comment"),c=document.querySelector(".social__caption"),i=document.querySelector(".social__comment-count"),a=()=>{s.innerHTML=null},d=(e,t)=>{const o=r.cloneNode(!0),s=o.querySelector(".social__picture");return o.querySelector(".social__text").textContent=e[t].message,s.src=e[t].avatar,o};let u=0,m=null;const v=()=>{e.classList.add("hidden"),a(),l.removeEventListener("click",p),y.removeEventListener("click",v)},p=()=>{const{comments:{length:e}}=m,t=u+5>e?e:u+5;(({comments:e},t)=>{a();for(let o=u;o<t;o++)n.append(d(e,o)),l.classList.remove("hidden");s.append(n)})(m,t),u=t,u===e&&l.classList.add("hidden")};i.classList.add("hidden");const y=document.querySelector(".big-picture__cancel");document.addEventListener("keydown",(e=>{"Escape"===e.key&&v()})),window.picture={show:s=>{u=0,m=s,l.addEventListener("click",p),y.addEventListener("click",v),(({url:s,description:n,likes:l})=>{t.src=s,c.textContent=n,o.textContent=l,e.classList.remove("hidden")})(s),l.classList.remove("hidden"),p()}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("#upload-file"),o=document.querySelector(".img-upload__preview img"),s=document.querySelectorAll(".effects__preview");window.photo={upload:()=>{const n=t.files[0],l=n.name.toLowerCase();if(e.some((e=>l.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result;for(let t=0;t<s.length;t++)s[t].style.backgroundImage=`url(${e.result})`})),e.readAsDataURL(n)}},fileChooser:t}})(),(()=>{const e=document.querySelector(".text__hashtags"),t=document.querySelector(".text__description");e.addEventListener("input",(()=>{const t=/^[\w\d]*$/,o=e.value.toLowerCase().split(" ").filter((e=>""!==e)),s=[...new Set(o)],n=[];for(let l=0;l<o.length;l++){if(n[l]=o[l],"#"===o[l][0]){const e=n[l].split("");e.splice(0,1),n[l]=e.join("")}switch(!0){case"#"!==o[l][0]:e.setCustomValidity("хэш - тег начинается с символа #(решётка)");break;case o[l].length<2&&"#"===o[l][0]&&o.length<=5:e.setCustomValidity("Ещё "+(2-o[l].length)+" симв.");break;case!1===t.test(n.join("")):e.setCustomValidity("строка после решётки должна состоять из букв и чисел и не может содержать пробелы, спецсимволы (#, @, $ и т. п.), символы");break;case o[l].length>20:e.setCustomValidity("Удалите лишние "+(o[l].length-20)+" симв. одного хэштега");break;case s.length<o.length:e.setCustomValidity("Oдин и тот же хэш-тег не может быть использован дважды.");break;case o.length>5&&"#"===o[l][0]:e.setCustomValidity("Нельзя указать больше пяти хэш-тегов");break;default:e.setCustomValidity("")}}e.reportValidity()})),t.addEventListener("input",(()=>{t.value.length>140?t.setCustomValidity("Длина комментария не может быть больше 140 символов."):t.setCustomValidity(""),t.reportValidity()})),window.validate={hashtagInput:e,comment:t}})(),(()=>{const{body:e}=document,t=e.querySelector(".img-upload__overlay"),o=e.querySelector("#upload-cancel"),s=e.querySelector(".img-upload__effect-level"),n=e.querySelector(".img-upload__scale"),l=n.querySelector(".scale__control--smaller"),r=n.querySelector(".scale__control--bigger"),c=n.querySelector(".scale__control--value"),i=e.querySelector(".img-upload__preview"),a=e.querySelector(".effect-level__line"),d=a.querySelector(".effect-level__pin"),u=a.querySelector(".effect-level__depth"),m=e.querySelector(".effect-level__value"),v=()=>{d.style.left="450px",u.style.width="100%"},p=e.querySelector(".effects__list"),y=e.querySelector(".img-upload__preview img");let f={};const _={value:""},g=()=>{t.classList.add("hidden"),e.classList.remove("modal-open")},h=e=>{c.value=e+"%",i.style.transform=`scale(${e/100})`};l.addEventListener("click",(()=>{(()=>{if(+c.value.slice(0,c.value.length-1)>25){const e=Number(c.value.slice(0,c.value.length-1))-25;h(e)}})()})),r.addEventListener("click",(()=>{(()=>{if(+c.value.slice(0,c.value.length-1)<100){const e=Number(c.value.slice(0,c.value.length-1))+25;h(e)}})()})),window.photo.fileChooser.addEventListener("change",(()=>{window.photo.upload(),t.classList.remove("hidden"),s.classList.add("hidden"),y.style.filter="none",v(),c.value="100%",c.value="100%",i.style.transform="scale(1)"})),o.addEventListener("click",(()=>{g()})),document.addEventListener("keydown",(e=>{(e=>{const t="Escape"===e.key,o=!e.target.matches('input[class="text__hashtags"]'),s=!e.target.matches('textarea[class="text__description"]');t&&o&&s&&(e.preventDefault(),g())})(e)}));const w={none:()=>{y.removeAttribute("class"),y.style.filter="none"},chrome:e=>{y.ClassName="effects__preview--chrome",y.style.filter=`grayscale(${(d.offsetLeft+e)/450})`},sepia:e=>{y.ClassName="effects__preview--sepia",y.style.filter=`sepia(${(d.offsetLeft+e)/450})`},marvin:e=>{y.ClassName="effects__preview--marvin",y.style.filter=`invert(${(d.offsetLeft+e)/4.5}%)`},phobos:e=>{y.classList="effects__preview--phobos",y.style.filter=`blur(${(d.offsetLeft+e)/150}px)`},heat:e=>{y.ClassName="effects__preview--heat",y.style.filter=`brightness(${1+(d.offsetLeft+e)/225})`}};p.addEventListener("change",(e=>{(e=>{w[e.target.value](450),_.value=e.target.value,v(),"none"!==e.target.value?s.classList.remove("hidden"):s.classList.add("hidden")})(e)})),d.addEventListener("mousedown",(e=>{f={x:e.clientX},document.addEventListener("mousemove",L),document.addEventListener("mouseup",S)}));const L=e=>{const t=f.x-e.clientX;if(f={x:e.clientX},d.offsetLeft-t>0&&d.offsetLeft-t<450){d.style.left=d.offsetLeft-t+"px",u.style.width=(d.offsetLeft-t)/4.5+"%";const e=d.style.left.length-2,o=d.style.left.substring(0,e);m.value=o,w[_.value](-t)}},S=()=>{document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",S)};window.preview={closePopup:g}})(),(()=>{const e=document.querySelector("main"),t=["#error",".error"],o=["#success",".success"],s=()=>{window.photo.fileChooser.value="",window.validate.hashtagInput.value="",window.validate.comment.value=""},n=(t,o)=>{const s=document.querySelector(t).content.querySelector(o).cloneNode(!0);e.append(s),document.querySelector(o).classList.add("hidden")};n(t[0],t[1]),n(o[0],o[1]);const l=document.querySelector(".error"),r=document.querySelector(".error__button"),c=document.querySelector(".success"),i=document.querySelector(".success__button"),a=document.querySelector(".success__inner"),d=document.querySelector(".error__inner"),u=()=>{c.classList.add("hidden")},m=()=>{l.classList.add("hidden")},v=document.querySelector(".img-upload__form"),p=()=>{window.preview.closePopup(),s(),c.classList.remove("hidden"),i.addEventListener("click",(()=>{u()})),c.addEventListener("click",(e=>{e.target!==a&&u()}))},y=e=>{document.querySelector(".error__title").textContent=e,window.preview.closePopup(),s(),l.classList.remove("hidden"),r.addEventListener("click",(()=>{m()})),l.addEventListener("click",(e=>{e.target!==d&&m()}))};v.addEventListener("submit",(e=>{window.http(p,y,new FormData(v)),e.preventDefault()}))})()})();
